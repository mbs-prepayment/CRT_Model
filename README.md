# CRT Model - 30天贷款违约预测模型

基于 Freddie Mac CRT (Credit Risk Transfer) 数据的30天贷款违约预测模型，使用 GAM (Generalized Additive Model) 进行建模。

## 📊 项目概述

本项目旨在预测贷款在未来30天内是否会发生违约，使用历史贷款数据（2013-2025）进行训练和评估。

### 核心特性

- ✅ **数据源**: Supabase 云数据库（40,000条样本，平衡数据集）
- ✅ **模型**: LogisticGAM（可解释性强）
- ✅ **评估方法**: 回测、时间序列外推、交叉验证
- ✅ **性能**: AUC ~0.74-0.78, F1 ~0.69-0.71

## 🚀 快速开始

### 1. 环境要求

- Python 3.9+
- Jupyter Notebook

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 运行模型

```bash
cd notebooks
jupyter notebook model_training.ipynb
```

在 Jupyter 中打开后，点击 `Kernel → Restart & Run All` 运行所有代码。

## 📁 项目结构

```
CRT_Model/
├── README.md                    # 项目说明
├── requirements.txt             # Python 依赖
├── .gitignore                   # Git 忽略规则
│
├── src/                         # 核心代码模块
│   ├── config.py                # 配置管理
│   ├── data/                    # 数据加载和预处理
│   ├── features/                # 特征工程
│   ├── models/                  # 模型定义
│   ├── evaluation/              # 模型评估
│   └── utils/                   # 工具函数
│
├── notebooks/                   # Jupyter Notebooks
│   ├── model_training.ipynb     # 主要训练 Notebook
│   └── *.csv                    # 数据缓存文件
│
├── scripts/                     # 工具脚本
│   ├── check_packages.py        # 环境检查
│   └── run_tests.sh             # 测试脚本
│
├── sql_scripts/                 # SQL 脚本
│   ├── 30 Days Delinquency...   # 数据表创建
│   └── Supabase 2013-2022...    # 原始数据表定义
│
├── archived/                    # 归档文件
│   └── ...                      # 旧版本文件
│
└── docs/                        # 文档
    └── REFACTORING_SUMMARY.txt  # 重构说明
```

## 🔧 主要功能

### 数据处理

- **数据源**: 从 Supabase 获取 Freddie Mac CRT 数据
- **数据量**: 40,000 条记录（20,000 正样本 + 20,000 负样本）
- **时间范围**: 2013-2025
- **缓存机制**: 首次运行从 API 下载，后续运行直接读取 CSV

### 特征工程

- 时间特征提取（年、月）
- 利率差异计算
- 高 DTI 标记
- 近期违约标记
- 地区违约率
- 分桶特征（LTV、信用分数等）

### 模型训练

- **算法**: LogisticGAM (Generalized Additive Model)
- **优点**: 可解释性强，非线性拟合能力好
- **校准**: Isotonic Regression 概率校准
- **类别平衡**: 使用类别权重处理不平衡数据

### 模型评估

1. **回测 (Backtesting)**: 
   - 训练集: 2013-2022
   - 测试集: 2013-2022（时间顺序划分）
   - AUC: ~0.78, F1: ~0.69

2. **时间序列外推 (Time-series Out-of-Sample)**:
   - 训练集: 2013-2022
   - 测试集: 2023-2025
   - AUC: ~0.74, F1: ~0.71

3. **交叉验证 (5-Fold Stratified CV)**:
   - 数据: 2013-2022
   - AUC: 0.73 ± 0.01
   - F1: 0.71 ± 0.00

## 📊 性能指标

| 评估方法 | AUC | F1 Score | 数据集 | 说明 |
|---------|-----|----------|--------|------|
| 回测 (Backtesting) | 0.7783 | 0.6879 | 2013-2022 | 历史数据随机划分 |
| 时间序列外推 (Time-series) | 0.7423 | 0.7112 | 2023-2025 | 最严格：预测未来 |
| 5折交叉验证 (5-Fold CV) | 0.7342±0.0071 | 0.7062±0.0034 | 2013-2022 | 评估稳定性 |

### 三种评估方法对比

```
┌─────────────────────────────────────────────────────────────────┐
│  Cell 4: 回测 (Backtesting)                                     │
├─────────────────────────────────────────────────────────────────┤
│  [2013 ──────────────── 2022]                                   │
│   ├─ 80% 训练 ─┤├─ 20% 测试 ─┤                                  │
│                                                                 │
│  特点: 随机划分，评估历史数据拟合能力                              │
│  结果: AUC 0.78, F1 0.69                                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Cell 5: 时间序列外推 (Time-series Out-of-Sample)               │
├─────────────────────────────────────────────────────────────────┤
│  [2013 ──── 2022] ──训练→ [2023 ─ 2025] ←预测                  │
│   历史数据 (训练)         未来数据 (测试)                         │
│                                                                 │
│  特点: 严格时间划分，模拟真实预测场景                              │
│  结果: AUC 0.74, F1 0.71                                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  Cell 6: 5折交叉验证 (5-Fold Cross-Validation)                  │
├─────────────────────────────────────────────────────────────────┤
│  [2013 ──────────────── 2022]                                   │
│   Fold 1: [■■■■ Train ■■■■][Test]                              │
│   Fold 2: [■■■■ Train ■■■■][Test]                              │
│   Fold 3: [Test][■■■■ Train ■■■■]                              │
│   Fold 4: [■■■■ Train ■■■■][Test]                              │
│   Fold 5: [■■■■ Train ■■■■][Test]                              │
│                                                                 │
│  特点: 多次验证，评估模型稳定性                                    │
│  结果: AUC 0.73±0.01, F1 0.71±0.00                              │
└─────────────────────────────────────────────────────────────────┘
```

### 为什么需要三种评估？

1. **回测 (Cell 4)**: 
   - ✅ 评估模型对历史数据的拟合能力
   - ✅ 最高的 AUC (0.78)，说明模型学习能力强
   - ⚠️ 可能存在过拟合风险

2. **时间序列外推 (Cell 5)**:
   - ✅ 最接近真实场景：用历史预测未来
   - ✅ AUC 0.74，说明模型有一定的外推能力
   - ✅ 这是最重要的评估指标

3. **交叉验证 (Cell 6)**:
   - ✅ 评估模型稳定性（标准差很小）
   - ✅ 避免单次划分的偶然性
   - ✅ AUC 0.73±0.01，说明模型很稳定

## 🛠️ 技术栈

- **数据处理**: pandas, numpy
- **机器学习**: scikit-learn, pygam
- **数据库**: Supabase (PostgreSQL)
- **可视化**: matplotlib
- **开发环境**: Jupyter Notebook

## 📝 使用说明

### Cell 0: 数据下载

首次运行时，Cell 0 会从 Supabase 下载数据并保存为 CSV：

```python
# 从 Supabase 下载 40,000 条数据
# 保存为: freddie_mac_delinquency_balanced.csv
# 保存为: freddie_mac_delinquency_strict_predict_ready_GAM.csv
```

后续运行时，直接读取 CSV 文件，无需重新下载。

### Cell 1-3: 数据预处理

- 提取时间特征
- 清洗数据
- 特征选择

### Cell 4-6: 模型训练与评估

#### Cell 4: 回测评估 (Backtesting)

**目标**: 评估模型在历史数据上的表现

**数据划分**:
```
训练集: 2013-2022 年数据 (80%)
测试集: 2013-2022 年数据 (20%)
```

**实现步骤**:
1. **数据准备**: 筛选 2013-2022 年的数据
2. **特征编码**: 对分类变量进行 Label Encoding
3. **构建 GAM 模型**: 
   - 连续变量使用样条函数 `s(i, n_splines=8)`
   - 分类变量使用因子函数 `f(i)`
4. **超参数调优**: 测试不同的 λ 值 (10, 20, 40, ..., 480)，选择 LogLoss 最小的
5. **概率校准**: 使用 Isotonic Regression 校准预测概率
6. **阈值优化**: 通过 ROC 曲线找到 F1 最大的阈值
7. **评估**: 计算 AUC、F1、Brier Score、LogLoss
8. **可视化**: 绘制前 10 个连续特征的 Partial Dependence Plots

**结果**: AUC ~0.78, F1 ~0.69

---

#### Cell 5: 时间序列外推评估 (Time-series Out-of-Sample)

**目标**: 评估模型对未来数据的预测能力

**数据划分**:
```
训练集: 2013-2022 年数据 (历史)
测试集: 2023-2025 年数据 (未来)
```

**实现步骤**:
1. **严格时间划分**: 
   - 训练集: 只使用 2013-2022 年数据
   - 测试集: 只使用 2023-2025 年数据
2. **移除时间泄漏**: 自动识别并移除时间相关特征（如 `period`, `year`, `month`）
3. **Label Encoder 处理未知类别**: 
   - 在训练集上 fit Label Encoder
   - 测试集遇到未知类别时，使用训练集的众数填充
4. **模型训练**: 在 2013-2022 数据上训练 GAM
5. **概率校准**: 使用训练集的一部分进行 Isotonic Regression 校准
6. **外推预测**: 在 2023-2025 数据上进行预测
7. **评估**: 计算 AUC、F1、Brier Score、LogLoss
8. **可视化**: 绘制测试集上的 Partial Dependence Plots

**结果**: AUC ~0.74, F1 ~0.71

**意义**: 这是最严格的评估，模拟真实生产环境中对未来数据的预测

---

#### Cell 6: 交叉验证评估 (5-Fold Stratified Cross-Validation)

**目标**: 评估模型的稳定性和泛化能力

**数据划分**:
```
数据: 2013-2022 年数据
方法: 5折分层交叉验证
```

**实现步骤**:
1. **数据准备**: 使用 2013-2022 年数据
2. **分层划分**: 使用 `StratifiedKFold(n_splits=5)` 确保每折中正负样本比例一致
3. **5次迭代**: 
   - Fold 1: 80% 训练, 20% 验证
   - Fold 2: 80% 训练, 20% 验证
   - ...
   - Fold 5: 80% 训练, 20% 验证
4. **每折操作**:
   - 在训练集上 fit Label Encoder
   - 训练 GAM 模型（超参数调优）
   - 使用 Isotonic Regression 校准
   - 在验证集上评估
5. **汇总结果**: 计算 5 折的平均值和标准差
6. **输出**: 
   - AUC: 均值 ± 标准差
   - F1: 均值 ± 标准差
   - Brier Score: 均值 ± 标准差
   - LogLoss: 均值 ± 标准差

**结果**: AUC 0.73 ± 0.01, F1 0.71 ± 0.00

**意义**: 通过多次验证，评估模型的稳定性，避免单次划分的偶然性

## 🔐 配置说明

### Supabase 连接

数据库连接信息在 `notebooks/model_training.ipynb` 的 Cell 0 中：

```python
url = "https://ptukzshzuloxipzwycte.supabase.co"
key = "your_api_key_here"
```

**注意**: 生产环境建议使用环境变量管理 API Key。

## 📈 模型可解释性

GAM 模型提供了良好的可解释性：

- **Partial Dependence Plots**: 展示每个特征对预测的影响
- **Feature Importance**: 通过 GAM 系数了解特征重要性
- **平滑曲线**: 可视化特征与目标变量的非线性关系

## 🚧 未来改进

- [ ] 添加更多特征工程
- [ ] 尝试其他模型（XGBoost、LightGBM）
- [ ] 实现模型持久化和部署
- [ ] 添加实时预测 API
- [ ] 完善文档和测试

## 📄 许可证

本项目仅供学习和研究使用。

## 👥 贡献

欢迎提出问题和建议！

## 📞 联系方式

如有问题，请通过 GitHub Issues 联系。

---

**最后更新**: 2024-11-21

