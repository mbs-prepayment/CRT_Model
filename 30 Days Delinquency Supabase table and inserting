CREATE TABLE freddie_mac_delinquency_30_model (
    loan_identifier TEXT,
    period TEXT,
    period_year TEXT,
    period_month TEXT,
    amortization_type TEXT,
    seller_name TEXT,
    property_state TEXT,
    msa TEXT,
    first_payment_date TEXT,
    maturity_date TEXT,
    original_loan_term TEXT,
    original_interest_rate TEXT,
    original_upb TEXT,
    loan_purpose TEXT,
    channel TEXT,
    property_type TEXT,
    number_of_units TEXT,
    occupancy_status TEXT,
    first_time_homebuyer_indicator TEXT,
    credit_score TEXT,
    original_loan_to_value_ltv TEXT,
    original_debt_to_income_dti_ratio TEXT,
    mortgage_insurance_percentage_mi_percent TEXT,

    loan_age TEXT,
    remaining_months_to_legal_maturity TEXT,
    current_loan_delinquency_status TEXT,
    payment_history TEXT,
    current_interest_rate TEXT,
    current_actual_upb TEXT,
    modification_flag TEXT,
    delinquency_due_to_disaster TEXT,
    bankruptcy_flag TEXT,
    number_of_modifications TEXT,
    modification_debt_to_income_ratio TEXT,
    interest_rate_step_indicator TEXT,
    property_valuation_method TEXT,
    borrower_assistance_plan TEXT,
    payment_deferral_flag TEXT,
    distressed_principal_balance_flag TEXT,

    delinquency_30d_label INT,
    loan_to_value_ratio_bucket TEXT,
    loan_age_years NUMERIC,
    interest_rate_diff NUMERIC,
    high_dti_flag INT,
    credit_score_bucket TEXT,
    recent_delinquency_flag INT,
    state_default_rate NUMERIC,
    msa_default_rate NUMERIC,
    loan_size_bucket TEXT,
    interest_rate_bucket TEXT,
    seasonality_flag INT,
    modification_history_flag INT
);

INSERT INTO freddie_mac_delinquency_30_model (
    loan_identifier,
    period,
    period_year,
    period_month,
    amortization_type,
    seller_name,
    property_state,
    msa,
    first_payment_date,
    maturity_date,
    original_loan_term,
    original_interest_rate,
    original_upb,
    loan_purpose,
    channel,
    property_type,
    number_of_units,
    occupancy_status,
    first_time_homebuyer_indicator,
    credit_score,
    original_loan_to_value_ltv,
    original_debt_to_income_dti_ratio,
    mortgage_insurance_percentage_mi_percent,
    loan_age,
    remaining_months_to_legal_maturity,
    current_loan_delinquency_status,
    payment_history,
    current_interest_rate,
    current_actual_upb,
    modification_flag,
    delinquency_due_to_disaster,
    bankruptcy_flag,
    number_of_modifications,
    modification_debt_to_income_ratio,
    interest_rate_step_indicator,
    property_valuation_method,
    borrower_assistance_plan,
    payment_deferral_flag,
    distressed_principal_balance_flag,
    delinquency_30d_label,
    loan_age_years,
    interest_rate_diff,
    high_dti_flag,
    recent_delinquency_flag
)
SELECT
    loan_identifier,
    period,
    LEFT(period, 4)::INT AS period_year,
    RIGHT(period, 2)::INT AS period_month,
    amortization_type,
    seller_name,
    property_state,
    msa,
    first_payment_date,
    maturity_date,
    original_loan_term,
    original_interest_rate,
    original_upb,
    loan_purpose,
    channel,
    property_type,
    number_of_units,
    occupancy_status,
    first_time_homebuyer_indicator,
    credit_score,
    original_loan_to_value_ltv,
    original_debt_to_income_dti_ratio,
    mortgage_insurance_percentage_mi_percent,
    loan_age,
    remaining_months_to_legal_maturity,
    current_loan_delinquency_status,
    payment_history,
    current_interest_rate,
    current_actual_upb,
    modification_flag,
    delinquency_due_to_disaster,
    bankruptcy_flag,
    number_of_modifications,
    modification_debt_to_income_ratio,
    interest_rate_step_indicator,
    property_valuation_method,
    borrower_assistance_plan,
    payment_deferral_flag,
    distressed_principal_balance_flag,
    1 AS delinquency_30d_label,
    ROUND(CAST(loan_age AS NUMERIC) / 12.0, 2) AS loan_age_years,
    ROUND(CAST(original_interest_rate AS NUMERIC) - CAST(current_interest_rate AS NUMERIC), 4) AS interest_rate_diff,
    CASE WHEN CAST(original_debt_to_income_dti_ratio AS NUMERIC) > 45 THEN 1 ELSE 0 END AS high_dti_flag,
    CASE WHEN RIGHT(payment_history, 3) ~ '[1-9]' THEN 1 ELSE 0 END AS recent_delinquency_flag
FROM freddie_mac_crt_raw_clean1
WHERE current_loan_delinquency_status = '01'
  AND LEFT(period, 4)::INT BETWEEN 2013 AND 2025
  AND credit_score ~ '^[0-9]+$'
  AND original_loan_to_value_ltv ~ '^[0-9]+(\.[0-9]+)?$'
  AND original_debt_to_income_dti_ratio ~ '^[0-9]+(\.[0-9]+)?$'
  AND current_interest_rate ~ '^[0-9]+(\.[0-9]+)?$'
  AND loan_age ~ '^[0-9]+$'
ORDER BY random()
LIMIT 20000;


INSERT INTO freddie_mac_delinquency_30_model (
    loan_identifier,
    period,
    period_year,
    period_month,
    amortization_type,
    seller_name,
    property_state,
    msa,
    first_payment_date,
    maturity_date,
    original_loan_term,
    original_interest_rate,
    original_upb,
    loan_purpose,
    channel,
    property_type,
    number_of_units,
    occupancy_status,
    first_time_homebuyer_indicator,
    credit_score,
    original_loan_to_value_ltv,
    original_debt_to_income_dti_ratio,
    mortgage_insurance_percentage_mi_percent,
    loan_age,
    remaining_months_to_legal_maturity,
    current_loan_delinquency_status,
    payment_history,
    current_interest_rate,
    current_actual_upb,
    modification_flag,
    delinquency_due_to_disaster,
    bankruptcy_flag,
    number_of_modifications,
    modification_debt_to_income_ratio,
    interest_rate_step_indicator,
    property_valuation_method,
    borrower_assistance_plan,
    payment_deferral_flag,
    distressed_principal_balance_flag,
    delinquency_30d_label,
    loan_age_years,
    interest_rate_diff,
    high_dti_flag,
    recent_delinquency_flag
)
SELECT
    loan_identifier,
    period,
    LEFT(period, 4)::INT AS period_year,
    RIGHT(period, 2)::INT AS period_month,
    amortization_type,
    seller_name,
    property_state,
    msa,
    first_payment_date,
    maturity_date,
    original_loan_term,
    original_interest_rate,
    original_upb,
    loan_purpose,
    channel,
    property_type,
    number_of_units,
    occupancy_status,
    first_time_homebuyer_indicator,
    credit_score,
    original_loan_to_value_ltv,
    original_debt_to_income_dti_ratio,
    mortgage_insurance_percentage_mi_percent,
    loan_age,
    remaining_months_to_legal_maturity,
    current_loan_delinquency_status,
    payment_history,
    current_interest_rate,
    current_actual_upb,
    modification_flag,
    delinquency_due_to_disaster,
    bankruptcy_flag,
    number_of_modifications,
    modification_debt_to_income_ratio,
    interest_rate_step_indicator,
    property_valuation_method,
    borrower_assistance_plan,
    payment_deferral_flag,
    distressed_principal_balance_flag,
    0 AS delinquency_30d_label,
    ROUND(CAST(loan_age AS NUMERIC) / 12.0, 2) AS loan_age_years,
    ROUND(CAST(original_interest_rate AS NUMERIC) - CAST(current_interest_rate AS NUMERIC), 4) AS interest_rate_diff,
    CASE WHEN CAST(original_debt_to_income_dti_ratio AS NUMERIC) > 45 THEN 1 ELSE 0 END AS high_dti_flag,
    CASE WHEN RIGHT(payment_history, 3) ~ '[1-9]' THEN 1 ELSE 0 END AS recent_delinquency_flag
FROM freddie_mac_crt_raw_clean1
TABLESAMPLE SYSTEM (1) 
WHERE current_loan_delinquency_status = '00'
  AND LEFT(period, 4)::INT BETWEEN 2013 AND 2025
  AND credit_score ~ '^[0-9]+$'
  AND original_loan_to_value_ltv ~ '^[0-9]+(\.[0-9]+)?$'
  AND original_debt_to_income_dti_ratio ~ '^[0-9]+(\.[0-9]+)?$'
  AND current_interest_rate ~ '^[0-9]+(\.[0-9]+)?$'
  AND loan_age ~ '^[0-9]+$'
ORDER BY random()
LIMIT 20000;

